---
- name: Pull latest Nebula Sync image
  community.docker.docker_image_pull:
    name: ghcr.io/lovelaze/nebula-sync:latest
  register: image_pull

- name: Update Nebula Sync container with latest image
  community.docker.docker_compose_v2:
    project_src: /data/services/nebula-sync
    files:
      - compose.yml
    state: present
    pull: always
    recreate: always
  when: image_pull.changed

- name: Display update status
  debug:
    msg: "Nebula Sync has been updated to the latest version"
  when: image_pull.changed

- name: Get list of all Nebula Sync images
  command: docker images ghcr.io/lovelaze/nebula-sync --format "{{ '{{' }}.ID{{ '}}' }}|{{ '{{' }}.CreatedAt{{ '}}' }}" --no-trunc
  register: nebula_sync_images
  changed_when: false

- name: Identify old Nebula Sync images to remove (keep 3 most recent)
  set_fact:
    images_to_remove: "{{ nebula_sync_images.stdout_lines | map('split', '|') | sort(attribute='1', reverse=true) | map(attribute='0') | list | [3:] }}"
  when: nebula_sync_images.stdout_lines | length > 3

- name: Remove old Nebula Sync images
  community.docker.docker_image:
    name: "{{ item }}"
    state: absent
    force_absent: true
  loop: "{{ images_to_remove }}"
  when:
    - images_to_remove is defined
    - images_to_remove | length > 0

- name: Display cleanup status
  debug:
    msg: "Removed {{ images_to_remove | length }} old Nebula Sync image(s), kept 3 most recent"
  when:
    - images_to_remove is defined
    - images_to_remove | length > 0
