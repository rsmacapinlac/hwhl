---
- name: Pull latest BorgBackup image
  community.docker.docker_image_pull:
    name: ghcr.io/borgmatic-collective/borgmatic:latest
  register: image_pull

- name: Update BorgBackup container with latest image
  community.docker.docker_compose_v2:
    project_src: /data/services
    files:
      - borgbackup.yml
    state: present
    pull: always
    recreate: always
  when: image_pull.changed

- name: Display update status
  debug:
    msg: "BorgBackup has been updated to the latest version"
  when: image_pull.changed

- name: Get list of all BorgBackup images
  command: docker images ghcr.io/borgmatic-collective/borgmatic --format "{{ '{{' }}.ID{{ '}}' }}|{{ '{{' }}.CreatedAt{{ '}}' }}" --no-trunc
  register: borgbackup_images
  changed_when: false

- name: Identify old BorgBackup images to remove (keep 3 most recent)
  set_fact:
    images_to_remove: "{{ borgbackup_images.stdout_lines | map('split', '|') | sort(attribute='1', reverse=true) | map(attribute='0') | list | [3:] }}"
  when: borgbackup_images.stdout_lines | length > 3

- name: Remove old BorgBackup images
  community.docker.docker_image:
    name: "{{ item }}"
    state: absent
    force_absent: true
  loop: "{{ images_to_remove }}"
  when:
    - images_to_remove is defined
    - images_to_remove | length > 0

- name: Display cleanup status
  debug:
    msg: "Removed {{ images_to_remove | length }} old BorgBackup image(s), kept 3 most recent"
  when:
    - images_to_remove is defined
    - images_to_remove | length > 0
