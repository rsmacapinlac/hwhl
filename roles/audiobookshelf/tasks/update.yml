---
# Update tasks for Audiobookshelf
# Pulls latest image and recreates container
# Run via: ansible-playbook maintenance.yml

- name: Update audiobookshelf container with latest image
  community.docker.docker_compose_v2:
    project_src: /data/services/audiobookshelf
    files:
      - compose.yml
    state: present
    pull: always
    recreate: always
    remove_orphans: false
  register: compose_update
  ignore_errors: true

- name: Wait for audiobookshelf container to be running
  community.docker.docker_container_info:
    name: audiobookshelf
  register: audiobookshelf_status
  until: audiobookshelf_status.container.State.Running | default(false)
  retries: 5
  delay: 2
  when: compose_update is succeeded

- name: Display update status
  debug:
    msg: "Audiobookshelf has been updated and is running"
  when: compose_update is succeeded

- name: Display skip message when service unavailable
  debug:
    msg: "Skipped audiobookshelf update - service unavailable or update failed"
  when: compose_update is failed

- name: Remove dangling audiobookshelf images
  command: docker image prune -f
  changed_when: true
  when: compose_update is succeeded
