---
services:
  monicacrm:
    image: monica
    container_name: monica
    depends_on:
      - monica_db
    ports:
      - {{ monica_port }}:80
    env_file:
      - .env
    volumes:
      - /data/containers/monica/data:/var/www/html/storage
      - /data/services/monica/.env:/var/www/html/.env:ro
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      # HTTP router with redirect to HTTPS
      - "traefik.http.routers.monica.entrypoints=http"
      - "traefik.http.routers.monica.rule=Host(`monica.{{ ansible_facts["hostname"] }}.{{ homelab_domain }}`)"
      - "traefik.http.middlewares.monica-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.monica.middlewares=monica-https-redirect"
      # HTTPS router
      - "traefik.http.routers.monica-secure.entrypoints=https"
      - "traefik.http.routers.monica-secure.rule=Host(`monica.{{ ansible_facts["hostname"] }}.{{ homelab_domain }}`)"
      - "traefik.http.routers.monica-secure.tls=true"
      - "traefik.http.routers.monica-secure.service=monica"
      - "traefik.http.services.monica.loadbalancer.server.port=80"
      - "traefik.docker.network=proxy"
    networks:
      - proxy

  monica_db:
    image: mariadb:11
    container_name: monica_db
    env_file:
      - .env
    volumes:
      - /data/containers/monica/db:/var/lib/mysql
    restart: always
    labels:
      ofelia.enabled: "true"
      ofelia.job-exec.monica_mariadb_maintenance.schedule: "0 30 1 * * 0"
      ofelia.job-exec.monica_mariadb_maintenance.command: "mariadb-check -u root -p{{ monica.mysql.root_password }} --auto-repair --optimize --all-databases"
    networks:
      - proxy

  monica_scheduler:
    image: monica
    container_name: monica_scheduler
    command: /usr/local/bin/cron.sh
    depends_on:
      - monica_db
      - monicacrm
    env_file:
      - .env
    volumes:
      - /data/containers/monica/data:/var/www/html/storage
      - /data/services/monica/.env:/var/www/html/.env:ro
    restart: unless-stopped
    networks:
      - proxy

networks:
  proxy:
    name: proxy
    external: true
