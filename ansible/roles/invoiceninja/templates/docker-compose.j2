---
services:
  app:
    container_name: invoiceninja
    image: invoiceninja/invoiceninja-debian:latest
    restart: unless-stopped
    env_file: .env
    volumes:
      - app_public:/var/www/html/public
      - app_storage:/var/www/html/storage
      - ./php-fpm-listen.conf:/usr/local/etc/php-fpm.d/zzz-listen.conf:ro
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    networks:
      - invoiceninja-internal

  nginx:
    container_name: invoiceninja-nginx
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "{{ invoiceninja_port | default(8012) }}:80"
    volumes:
      - ./nginx/laravel.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/invoiceninja.conf:/etc/nginx/conf.d/invoiceninja.conf:ro
      - app_public:/var/www/html/public:ro
      - app_storage:/var/www/html/storage:ro
    depends_on:
      - app
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.enable=true"
      - "traefik.http.routers.invoiceninja.entrypoints=http"
      - "traefik.http.routers.invoiceninja.rule=Host(`invoiceninja.{{ ansible_facts["hostname"] }}.{{ homelab_domain }}`)"
      - "traefik.http.middlewares.invoiceninja-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.invoiceninja.middlewares=invoiceninja-https-redirect"
      - "traefik.http.routers.invoiceninja-secure.entrypoints=https"
      - "traefik.http.routers.invoiceninja-secure.rule=Host(`invoiceninja.{{ ansible_facts["hostname"] }}.{{ homelab_domain }}`)"
      - "traefik.http.routers.invoiceninja-secure.tls=true"
      - "traefik.http.routers.invoiceninja-secure.service=invoiceninja"
      - "traefik.http.services.invoiceninja.loadbalancer.server.port=80"
      - "traefik.docker.network=proxy"
    networks:
      - proxy
      - invoiceninja-internal

  mysql:
    container_name: invoiceninja-mysql
    image: mysql:8
    restart: unless-stopped
    env_file: .env
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 20s
      timeout: 10s
      retries: 5
    networks:
      - invoiceninja-internal

  redis:
    container_name: invoiceninja-redis
    image: redis:alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - invoiceninja-internal

volumes:
  app_public:
  app_storage:
  mysql_data:
  redis_data:

networks:
  proxy:
    name: proxy
    external: true
  invoiceninja-internal:
    driver: bridge
