---
# ============================================
# Terraform User and API Token Setup
# ============================================
# This file sets up Proxmox for Terraform automation by:
#   1. Creating a dedicated Terraform user (if it doesn't exist)
#   2. Granting Administrator role to the user
#   3. Creating an API token for Terraform operations
#   4. Saving the token to terraform/.proxmox-token
#   5. Generating terraform.tfvars configuration file
#
# Can be skipped with: -e setup_terraform=false
#
# NOTE: User/token tasks only run on the first node in the inventory
#       since Proxmox clusters share user configuration across all nodes.
# ============================================

- name: Check if terraform.tfvars already exists
  stat:
    path: "{{ playbook_dir }}/../terraform/terraform.tfvars"
  register: terraform_tfvars_stat
  delegate_to: localhost
  become: false
  when: inventory_hostname == ansible_play_hosts[0]

- name: Generate terraform.tfvars file
  template:
    src: "{{ playbook_dir }}/roles/proxmox/templates/terraform.tfvars.j2"
    dest: "{{ playbook_dir }}/../terraform/terraform.tfvars"
    mode: '0600'
  delegate_to: localhost
  become: false
  when:
    - inventory_hostname == ansible_play_hosts[0]
    - not terraform_tfvars_stat.stat.exists

