---
# ============================================
# Terraform User and API Token Setup
# ============================================
# This file sets up Proxmox for Terraform automation
# Can be skipped with: -e setup_terraform=false
#
# NOTE: User/token tasks only run on first node since
# Proxmox clusters share user configuration

- name: Check if terraform user exists
  shell: pveum user list | grep -q "{{ terraform_user }}"
  register: terraform_user_exists
  failed_when: false
  changed_when: false
  when: inventory_hostname == ansible_play_hosts[0]

- name: Create terraform user
  command: >
    pveum user add {{ terraform_user }}
    --comment "{{ terraform_comment }}"
  when:
    - inventory_hostname == ansible_play_hosts[0]
    - terraform_user_exists.rc != 0
  register: terraform_user_created

- name: Display terraform user creation status
  debug:
    msg: "Terraform user {{ terraform_user }} created"
  when:
    - inventory_hostname == ansible_play_hosts[0]
    - terraform_user_created is changed

- name: Grant Administrator role to terraform user
  command: >
    pveum aclmod / -user {{ terraform_user }} -role {{ terraform_role }}
  when:
    - inventory_hostname == ansible_play_hosts[0]
    - terraform_user_created is changed

- name: Check if terraform token exists
  shell: pveum user token list {{ terraform_user }} | grep -q "{{ terraform_token_name }}"
  register: terraform_token_exists
  failed_when: false
  changed_when: false
  when: inventory_hostname == ansible_play_hosts[0]

- name: Remove existing token if regeneration requested
  command: >
    pveum user token remove {{ terraform_user }} {{ terraform_token_name }}
  when:
    - inventory_hostname == ansible_play_hosts[0]
    - terraform_token_exists.rc == 0
    - terraform_force_regenerate_token | default(false) | bool

- name: Create API token for terraform user
  shell: >
    pveum user token add {{ terraform_user }} {{ terraform_token_name }} --privsep 0 --output-format json
  register: terraform_token_output
  when:
    - inventory_hostname == ansible_play_hosts[0]
    - (terraform_token_exists.rc | default(1)) != 0 or (terraform_force_regenerate_token | default(false) | bool)
  changed_when: true

- name: Parse token output
  set_fact:
    terraform_api_token: "{{ (terraform_token_output.stdout | from_json).value }}"
    terraform_full_token_id: "{{ (terraform_token_output.stdout | from_json)['full-tokenid'] }}"
  when:
    - inventory_hostname == ansible_play_hosts[0]
    - terraform_token_output is changed

- name: Display token information
  debug:
    msg: |
      ==========================================
      Terraform API Token Created
      ==========================================
      Full Token ID: {{ terraform_full_token_id }}
      Token Secret: {{ terraform_api_token }}

      Full API Token:
      {{ terraform_full_token_id }}={{ terraform_api_token }}
      ==========================================
  when:
    - inventory_hostname == ansible_play_hosts[0]
    - terraform_token_output is changed

- name: Save token to local file
  copy:
    content: |
      # Proxmox API Token for Terraform
      # Generated by Ansible on {{ ansible_date_time.iso8601 }}
      # Proxmox Node: {{ inventory_hostname }}

      PROXMOX_API_TOKEN_ID={{ terraform_full_token_id }}
      PROXMOX_API_TOKEN_SECRET={{ terraform_api_token }}
      PROXMOX_API_TOKEN_FULL={{ terraform_full_token_id }}={{ terraform_api_token }}
    dest: "{{ playbook_dir }}/../terraform/.proxmox-token"
    mode: '0600'
  delegate_to: localhost
  become: false
  when:
    - inventory_hostname == ansible_play_hosts[0]
    - terraform_token_output is changed

- name: Generate terraform.tfvars file
  template:
    src: terraform.tfvars.j2
    dest: "{{ playbook_dir }}/../terraform/terraform.tfvars"
    mode: '0600'
  delegate_to: localhost
  become: false
  when: inventory_hostname == ansible_play_hosts[0]

- name: Display setup completion message
  debug:
    msg: |
      ==========================================
      Terraform Setup Complete
      ==========================================

      Terraform user: {{ terraform_user }}
      API token generated: {{ 'Yes' if (terraform_token_output is defined and terraform_token_output is changed) else 'Already exists' }}
      Configuration file: {{ playbook_dir }}/../terraform/terraform.tfvars

      Next steps:
      1. Review terraform/terraform.tfvars
      2. Run: cd terraform && terraform init
      3. Run: cd terraform && terraform plan
      ==========================================
  when: inventory_hostname == ansible_play_hosts[0]
