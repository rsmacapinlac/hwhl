---
# Setup tasks for Bazarr environment file creation
# Run via: ansible-playbook site-setup.yml

- name: Create bazarr config directory locally
  file:
    path: "{{ playbook_dir }}/files/config/bazarr"
    state: directory
    mode: '0755'
  delegate_to: 127.0.0.1
  become: false

- name: Check if environment file already exists
  stat:
    path: "{{ playbook_dir }}/files/config/bazarr/environment"
  register: bazarr_env_file
  delegate_to: 127.0.0.1
  become: false

- name: Create environment file from template
  template:
    src: ../templates/environment.j2
    dest: "{{ playbook_dir }}/files/config/bazarr/environment"
    mode: '0640'
  when: not bazarr_env_file.stat.exists
  delegate_to: 127.0.0.1
  become: false

- name: Display setup instructions
  debug:
    msg: |
      Bazarr environment file created at: {{ playbook_dir }}/files/config/bazarr/environment

      Please review and update the following settings:
      - PUID/PGID: User and group IDs for container permissions
      - TZ: Timezone for the service

      Media library volumes should be configured in your inventory file using the 'sonarr' and 'radarr' variables.
      Bazarr mounts volumes from both Sonarr and Radarr for subtitle management.
      Example:
        sonarr:
          - { host_folder: "/mnt/media/tv", container: "/tv" }
        radarr:
          - { host_folder: "/mnt/media/movies", container: "/movies" }

      After configuration, deploy with: ansible-playbook site.yml --limit bazarr
  when: not bazarr_env_file.stat.exists
  delegate_to: 127.0.0.1
  become: false
