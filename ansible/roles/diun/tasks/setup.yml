---
# Setup tasks for Diun environment file creation
# Run via: ansible-playbook site-setup.yml

- name: Create diun config directory locally
  file:
    path: "{{ playbook_dir }}/files/config/diun"
    state: directory
    mode: '0755'
  delegate_to: 127.0.0.1
  become: false

- name: Check if environment file already exists
  stat:
    path: "{{ playbook_dir }}/files/config/diun/environment"
  register: diun_env_file
  delegate_to: 127.0.0.1
  become: false

- name: Create environment file from template
  template:
    src: "{{ playbook_dir }}/roles/diun/templates/environment.j2"
    dest: "{{ playbook_dir }}/files/config/diun/environment"
    mode: '0640'
  when: not diun_env_file.stat.exists
  delegate_to: 127.0.0.1
  become: false

- name: Display setup instructions
  debug:
    msg: |
      Diun environment file created at: {{ playbook_dir }}/files/config/diun/environment

      Please review and update the following notification settings:
      - Slack: Set DIUN_NOTIF_SLACK_WEBHOOKURL to enable Slack notifications
      - Email: Configure SMTP settings (host, port, username, password, from, to)
      - Discord: Set DIUN_NOTIF_DISCORD_WEBHOOKURL to enable Discord notifications

      Schedule configuration:
      - DIUN_WATCH_SCHEDULE: {{ diun_watch_schedule }} (cron format)
      - Can be overridden in inventory with 'diun_watch_schedule' variable

      After configuration, deploy with: ansible-playbook site.yml --limit diun
  when: not diun_env_file.stat.exists
  delegate_to: 127.0.0.1
  become: false
