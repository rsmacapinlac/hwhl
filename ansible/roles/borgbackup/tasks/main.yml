---
#- name: "Mount ContainerBackups share for BorgBackup"
#  include_tasks: roles/shares/tasks/single_share.yml
#  vars:
#    type: "{{ borgbackup_share_type }}"
#    destination: "{{ borgbackup_share_destination }}"
#    source: "{{ borgbackup_share_source }}"
#    options: "{{ borgbackup_share_options }}"
#  when: borgbackup_mount_share | default(true)
#
- name: Create Borg repository base directory
  become: true
  ansible.builtin.file:
    path: "/data/borgbackup/{{ ansible_facts['hostname'] }}"
    state: directory

- name: Create the 'proxy' network
  community.docker.docker_network:
    name: proxy

- name: Create BorgBackup config directory
  become: true
  ansible.builtin.file:
    path: /data/containers/borgbackup
    state: directory
    owner: ansible
    group: docker
    mode: '0755'

- name: Create BorgBackup crontab directory
  become: true
  ansible.builtin.file:
    path: /data/containers/borgbackup/cron
    state: directory
    owner: ansible
    group: docker
    mode: '0755'

- name: Deploy Borgmatic configuration
  become: true
  template:
    src: borgmatic-config.yml.j2
    dest: /data/containers/borgbackup/config.yaml
    owner: ansible
    group: docker
    mode: '0600'

- name: Deploy crontab for Borgmatic
  become: true
  template:
    src: crontab.txt.j2
    dest: /data/containers/borgbackup/cron/crontab.txt
    owner: ansible
    group: docker
    mode: '0644'

# Container status check
- name: Check if borgbackup container exists
  community.docker.docker_container_info:
    name: borgbackup
  register: borgbackup_container
  ignore_errors: true

# IMPORTANT: NO CONDITIONALS on directory/compose deployment!
- name: Create borgbackup service folder
  become: true
  ansible.builtin.file:
    path: /data/services/borgbackup
    state: directory
    owner: ansible
    group: docker
    mode: '0755'

# IMPORTANT: NO CONDITIONAL - must always deploy for handlers to work!
- name: Setup docker compose file for borgbackup
  become: true
  template:
    src: docker-compose.j2
    dest: /data/services/borgbackup/compose.yml
    owner: ansible
    group: docker
    mode: '0644'
  notify: restart borgbackup

# ONLY this task should be conditional!
- name: Run borgbackup container
  community.docker.docker_compose_v2:
    project_src: /data/services/borgbackup
    files:
      - compose.yml
    state: present
    remove_orphans: false
  when: not borgbackup_container.container.State.Running | default(false)
  notify: restart borgbackup

- name: Wait for container to be ready
  pause:
    seconds: 5

- name: Check if Borg repository is initialized
  become: true
  shell:
    cmd: "docker exec borgbackup borg info /mnt/borg-repository"
  register: borg_repo_check
  ignore_errors: true
  changed_when: false

- name: Initialize Borg repository if needed
  become: true
  shell:
    cmd: "docker exec borgbackup borg init --encryption=repokey /mnt/borg-repository"
  when: borg_repo_check.rc != 0
  register: borg_init_result

- name: Display repository initialization result
  debug:
    msg: "Borg repository initialized successfully for {{ ansible_facts['hostname'] }}"
  when: borg_init_result is changed
