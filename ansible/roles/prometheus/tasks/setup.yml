---
- name: Create config directory for prometheus
  ansible.builtin.file:
    path: "{{ playbook_dir }}/../homelab_config/ansible/files/config/prometheus"
    state: directory
    mode: '0755'
  delegate_to: localhost
  become: false

- name: Check if prometheus environment file exists
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/../homelab_config/ansible/files/config/prometheus/environment"
  register: env_file_stat
  delegate_to: localhost
  become: false

- name: Create prometheus environment file
  ansible.builtin.template:
    src: ../templates/environment.j2
    dest: "{{ playbook_dir }}/../homelab_config/ansible/files/config/prometheus/environment"
  when: not env_file_stat.stat.exists
  register: env_created
  delegate_to: localhost
  become: false

- name: Check if prometheus.yml exists
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/../homelab_config/ansible/files/config/prometheus/prometheus.yml"
  register: prom_config_stat
  delegate_to: localhost
  become: false

- name: Create default prometheus.yml
  ansible.builtin.template:
    src: ../templates/prometheus.yml.j2
    dest: "{{ playbook_dir }}/../homelab_config/ansible/files/config/prometheus/prometheus.yml"
  when: not prom_config_stat.stat.exists
  register: prom_config_created
  delegate_to: localhost
  become: false

- name: Create host-specific config directory for prometheus
  ansible.builtin.file:
    path: "{{ playbook_dir }}/../homelab_config/hosts/{{ inventory_hostname_short }}/prometheus"
    state: directory
    mode: '0755'
  delegate_to: localhost
  become: false

- name: Check if host-specific prometheus.yml exists
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/../homelab_config/hosts/{{ inventory_hostname_short }}/prometheus/prometheus.yml"
  register: host_prom_config_stat
  delegate_to: localhost
  become: false

- name: Create host-specific prometheus.yml from base
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../homelab_config/ansible/files/config/prometheus/prometheus.yml"
    dest: "{{ playbook_dir }}/../homelab_config/hosts/{{ inventory_hostname_short }}/prometheus/prometheus.yml"
  when: not host_prom_config_stat.stat.exists
  delegate_to: localhost
  become: false

- name: Display setup instructions
  debug:
    msg: |
      {% if env_file_stat.stat.exists %}
      Environment file already exists at {{ playbook_dir }}/../homelab_config/ansible/files/config/prometheus/environment
      Skipping creation to preserve your custom configuration.
      {% else %}
      Environment file has been created at {{ playbook_dir }}/../homelab_config/ansible/files/config/prometheus/environment
      Please review and customize this file with your desired configuration before running site.yml
      {% endif %}
      {% if prom_config_stat.stat.exists %}
      Base prometheus.yml already exists at {{ playbook_dir }}/../homelab_config/ansible/files/config/prometheus/prometheus.yml
      {% else %}
      Default prometheus.yml has been created at {{ playbook_dir }}/../homelab_config/ansible/files/config/prometheus/prometheus.yml
      {% endif %}
      Host-specific config at {{ playbook_dir }}/../homelab_config/hosts/{{ inventory_hostname_short }}/prometheus/prometheus.yml
      Customize per-host prometheus.yml files before running site.yml.