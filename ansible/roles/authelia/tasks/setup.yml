---
# Setup tasks for Authelia environment file creation
# Run via: ansible-playbook site-setup.yml

- name: Create authelia config directory locally
  file:
    path: "{{ playbook_dir }}/files/config/authelia"
    state: directory
    mode: '0755'
  delegate_to: 127.0.0.1
  become: false

- name: Create authelia secrets directory locally
  file:
    path: "{{ playbook_dir }}/files/config/authelia/secrets"
    state: directory
    mode: '0700'
  delegate_to: 127.0.0.1
  become: false

- name: Check if environment file already exists
  stat:
    path: "{{ playbook_dir }}/files/config/authelia/environment"
  register: authelia_env_file
  delegate_to: 127.0.0.1
  become: false

- name: Create authelia environment file
  template:
    src: "{{ playbook_dir }}/roles/authelia/templates/environment.j2"
    dest: "{{ playbook_dir }}/files/config/authelia/environment"
    mode: '0640'
  when: not authelia_env_file.stat.exists
  delegate_to: 127.0.0.1
  become: false

- name: Check if configuration.yml already exists
  stat:
    path: "{{ playbook_dir }}/files/config/authelia/configuration.yml"
  register: authelia_config_file
  delegate_to: 127.0.0.1
  become: false

- name: Create authelia configuration.yml
  template:
    src: "{{ playbook_dir }}/roles/authelia/templates/configuration.j2"
    dest: "{{ playbook_dir }}/files/config/authelia/configuration.yml"
    mode: '0640'
  when: not authelia_config_file.stat.exists
  delegate_to: 127.0.0.1
  become: false

- name: Check if users_database.yml already exists
  stat:
    path: "{{ playbook_dir }}/files/config/authelia/users_database.yml"
  register: authelia_users_file
  delegate_to: 127.0.0.1
  become: false

- name: Copy users_database.yml to config directory
  copy:
    src: "{{ playbook_dir }}/roles/authelia/files/users_database.yml"
    dest: "{{ playbook_dir }}/files/config/authelia/users_database.yml"
    mode: '0640'
  when: not authelia_users_file.stat.exists
  delegate_to: 127.0.0.1
  become: false

# Create secret files
- name: Check if jwt_secret already exists
  stat:
    path: "{{ playbook_dir }}/files/config/authelia/secrets/jwt_secret"
  register: authelia_jwt_secret_file
  delegate_to: 127.0.0.1
  become: false

- name: Create jwt_secret file
  copy:
    content: "{{ authelia_jwt_secret }}"
    dest: "{{ playbook_dir }}/files/config/authelia/secrets/jwt_secret"
    mode: '0600'
  when: not authelia_jwt_secret_file.stat.exists
  delegate_to: 127.0.0.1
  become: false

- name: Check if storage_encryption_key already exists
  stat:
    path: "{{ playbook_dir }}/files/config/authelia/secrets/storage_encryption_key"
  register: authelia_storage_key_file
  delegate_to: 127.0.0.1
  become: false

- name: Create storage_encryption_key file
  copy:
    content: "{{ authelia_storage_encryption }}"
    dest: "{{ playbook_dir }}/files/config/authelia/secrets/storage_encryption_key"
    mode: '0600'
  when: not authelia_storage_key_file.stat.exists
  delegate_to: 127.0.0.1
  become: false

- name: Check if session_secret already exists
  stat:
    path: "{{ playbook_dir }}/files/config/authelia/secrets/session_secret"
  register: authelia_session_secret_file
  delegate_to: 127.0.0.1
  become: false

- name: Generate session_secret file
  copy:
    content: "{{ lookup('password', '/dev/null length=64 chars=ascii_letters,digits') }}"
    dest: "{{ playbook_dir }}/files/config/authelia/secrets/session_secret"
    mode: '0600'
  when: not authelia_session_secret_file.stat.exists
  delegate_to: 127.0.0.1
  become: false

- name: Display setup instructions
  debug:
    msg: |
      Authelia configuration files created at: {{ playbook_dir }}/files/config/authelia/

      Files created:
        - environment (Docker environment variables)
        - configuration.yml (Authelia main config)
        - users_database.yml (User credentials)
        - secrets/jwt_secret
        - secrets/storage_encryption_key
        - secrets/session_secret

      Please review and customize these files before running site.yml.
      After customization, run: ansible-playbook site.yml --limit edge --tags authelia
  delegate_to: 127.0.0.1
  become: false
