---
- name: Create config directory for kimai
  file:
    path: "{{ playbook_dir }}/../homelab_config/ansible/files/config/kimai"
    state: directory
    mode: '0755'
  delegate_to: 127.0.0.1
  become: false

- name: Check if kimai environment file exists
  stat:
    path: "{{ playbook_dir }}/../homelab_config/ansible/files/config/kimai/environment"
  register: env_file_stat
  delegate_to: 127.0.0.1
  become: false

- name: Create kimai environment file
  template:
    src: environment.j2
    dest: "{{ playbook_dir }}/../homelab_config/ansible/files/config/kimai/environment"
    mode: '0640'
  when: not env_file_stat.stat.exists
  delegate_to: 127.0.0.1
  become: false

- name: Display setup instructions
  debug:
    msg: |
      {% if env_file_stat.stat.exists %}
      Environment file already exists at {{ playbook_dir }}/../homelab_config/ansible/files/config/kimai/environment
      Skipping creation to preserve your custom configuration.
      {% else %}
      Environment file has been created at {{ playbook_dir }}/../homelab_config/ansible/files/config/kimai/environment
      Please review and customize this file with your desired configuration before running site.yml
      {% endif %}
      After customization, you can run site.yml to deploy the services. 