---
# Setup tasks for Outline environment file creation
# Run via: ansible-playbook site-setup.yml

- name: Create outline config directory locally
  file:
    path: "{{ playbook_dir }}/../homelab_config/ansible/files/config/outline"
    state: directory
    mode: '0755'
  delegate_to: 127.0.0.1
  become: false

- name: Check if environment file already exists
  stat:
    path: "{{ playbook_dir }}/../homelab_config/ansible/files/config/outline/environment"
  register: outline_env_file
  delegate_to: 127.0.0.1
  become: false

- name: Create environment file from template
  template:
    src: ../templates/environment.j2
    dest: "{{ playbook_dir }}/../homelab_config/ansible/files/config/outline/environment"
    mode: '0640'
  when: not outline_env_file.stat.exists
  delegate_to: 127.0.0.1
  become: false

- name: Display setup instructions
  debug:
    msg: |
      Outline environment file created at: {{ playbook_dir }}/../homelab_config/ansible/files/config/outline/environment

      IMPORTANT: Please review and configure the following settings:

      Required Configuration:
      - SECRET_KEY: Generate a secure random key (use: openssl rand -hex 32)
      - UTILS_SECRET: Generate another secure random key
      - DATABASE_URL: PostgreSQL connection (auto-configured in compose)
      - REDIS_URL: Redis connection (auto-configured in compose)
      - URL: Your public-facing URL (e.g., https://outline.yourdomain.com)

      Authentication (at least one required):
      - Google OAuth: GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET
      - Email/SMTP: SMTP_* settings for magic link authentication

      Optional Configuration:
      - AWS_* or S3_*: For S3-compatible file storage
      - SLACK_*: For Slack integration
      - OIDC_*: For Authelia/OIDC authentication
      - FILE_STORAGE: Set to 'local' for local storage (default)

      After configuration, deploy with: ansible-playbook site.yml --limit outline
  when: not outline_env_file.stat.exists
  delegate_to: 127.0.0.1
  become: false
