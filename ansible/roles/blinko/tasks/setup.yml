---
- name: Create blinko config directory locally
  file:
    path: "{{ playbook_dir }}/../homelab_config/ansible/files/config/blinko"
    state: directory
    mode: '0755'
  delegate_to: 127.0.0.1
  become: false

- name: Check if environment file already exists
  stat:
    path: "{{ playbook_dir }}/../homelab_config/ansible/files/config/blinko/environment"
  register: blinko_env_file
  delegate_to: 127.0.0.1
  become: false

- name: Create environment file from template
  template:
    src: ../templates/environment.j2
    dest: "{{ playbook_dir }}/../homelab_config/ansible/files/config/blinko/environment"
    mode: '0640'
  when: not blinko_env_file.stat.exists
  delegate_to: 127.0.0.1
  become: false

- name: Display setup instructions
  debug:
    msg: |
      Blinko environment file created at: {{ playbook_dir }}/../homelab_config/ansible/files/config/blinko/environment

      CRITICAL SECURITY SETTINGS - MUST BE CHANGED:
      - NEXTAUTH_SECRET: Generate a secure random string (use: openssl rand -base64 32)
      - POSTGRES_PASSWORD: Set a strong database password
      - DATABASE_URL: Update with the new PostgreSQL password

      After updating the security settings, deploy with: ansible-playbook site.yml --limit blinko
  when: not blinko_env_file.stat.exists
  delegate_to: 127.0.0.1
  become: false
