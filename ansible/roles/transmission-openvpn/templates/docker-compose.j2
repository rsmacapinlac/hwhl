---
services:
  transmission-openvpn:
    image: haugene/transmission-openvpn:latest
    container_name: transmission-openvpn
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    env_file:
      - .env
    volumes:
      - /data/containers/transmission-openvpn/data:/data
      - /data/containers/transmission-openvpn/config:/config
      - /data/arrs/Downloads/transmission/incomplete:/incomplete
      - /data/arrs/Downloads/transmission/watch:/watch
      - /data/arrs/Downloads/transmission/completed:/completed
    ports:
      - {{ transmission_port }}:9091
    sysctls:
      - "net.ipv6.conf.all.disable_ipv6=0"
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: 10m
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.enable=true"
      # HTTP router with redirect to HTTPS
      - "traefik.http.routers.transmission.entrypoints=http"
      - "traefik.http.routers.transmission.rule=Host(`transmission.{{ ansible_facts['hostname'] }}.{{ homelab_domain }}`)"
      - "traefik.http.middlewares.transmission-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.transmission.middlewares=transmission-https-redirect"
      # HTTPS router
      - "traefik.http.routers.transmission-secure.entrypoints=https"
      - "traefik.http.routers.transmission-secure.rule=Host(`transmission.{{ ansible_facts['hostname'] }}.{{ homelab_domain }}`)"
      - "traefik.http.routers.transmission-secure.tls=true"
      - "traefik.http.routers.transmission-secure.service=transmission"
      - "traefik.http.services.transmission.loadbalancer.server.port=9091"
      - "traefik.docker.network=proxy"
    networks:
      - proxy

networks:
  proxy:
    name: proxy
    external: true
